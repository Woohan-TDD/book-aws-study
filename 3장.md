# 3장 
## 2장까지 했던 내용 
- EC2 인스턴스 1대 생성후, 웹서버와 웹 애프리케이션 서버를 구성한 뒤, 프러덕션을 서버에 배포.
	- EC2 생성시 SG, 인스턴스 사양설정
	- 웹서버 (Nginx) -> WAS 리버스 프록싱 설정

## 3장의 목표. 
1. ASG를 익히자  
	- ASG에 EC2 인스턴스의 기본적인 설정을 Launch Template을 통해 적용해보자. 
	- ASG 설정을 통해 인스턴스 갯수 및 변경 조건을 커스텀 하자. 
2. ELB를 익히자.
	- 앞서 설정했던 ASG에 로드밸런서를 붙인뒤, 로드밸런서 동작을 확인한다. 
		- 로드밸런서 생성후, 해당 로드밸런서에 연결할 인스턴스 그룹 (Target Group) 생성 후 ASG를 Target Group에 붙이자. 
		- Target Group 내 ASG 내부 인스턴스에 의도적인 장애 발생을 통해 로드밸런서의 역할을 확인한다.



#### Install Ruby (CodeDeploy Agent를 설치하기 위해 필요하다)
1. key 내려받기 , 내려받으려는 rvm 패키지가 유효한 패키지인지 확인하는데 사용되는 공개키이다. 
```sh
gpg --keyserver hkp://pool.sks-keyservers.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
```
2. stable 버전의 rvm을 받는다.
```sh
curl -sSL https://get.rvm.io | bash -s stable
```

3. 현재 터미널 세션에서 rvm 명령어를 사용할 수 있도록 한다. 
```sh
source /home/ec2-user/.rvm/scripts/rvm
```

4. 루비를 설치하는데 필요한 라이브러리 등을 설치한다. 
```sh
rvm requirements run
```

5. 루비를 설치한다. 
```sh
rvm install 2.4.3
```

---
#### CodeDeploy Agent 설치하기 
- EC2 인스턴스에 CodeDeploy Agent 설치 후 해당 인스턴스를 AMI로 만들어야 한다. 
1. 설치 스크립트 받기 
```sh
wget https://aws-codedeploy-ap-northeast-2.s3.amazonaws.com/latest/install
```

2. 내려받은 스크립트를 실행할 수 있도록 파일의 권한을 변경한다. 
```sh
chmod +x ./install
```
3. 스크립트를 실행해 현재 EC2 인스턴스에 맞는 CodeDeploy Agent 를 설치후 실행한다. 
- 서비스 등록 등의 작업을 위해 root 권한이 필요하다 
- 설치시 자동으로 시작 서비스에 등록된다. 
```sh
sudo ./install auto
```

4. 설치된 CodeDeploy Agent가 올바르게 실행됐는지 확인해본다. 
```sh
sudo service codedeploy-agent status
```

5. CodeDeploy Agent가 무사히 실행되고 있다면, 해당 인스턴스를 종료한다. 
```sh
sudo shutdown -h now
```

5-1. nginx를 시작 서비스에 등록한다. 
```sh
sudo chkconfig nginx on
```	